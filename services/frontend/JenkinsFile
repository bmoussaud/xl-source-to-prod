pipeline {
    environment {
        registry = "localhost:5000/xl-demo-frontend"
        dockerCredentials = 'minikube'
        dockerImage = ''
        appversion = "1.0.$BUILD_NUMBER"
        imageTag = registry + ":" + appversion
    }
    agent any
    stages {
        stage('Cloning Git') {
            steps {
                git 'https://github.com/bmoussaud/xl-source-to-prod.git'
            }
        }
        stage('Building image') {
            steps {
                script {
                    docker.withServer('tcp://192.168.130.134:2376', dockerCredentials) {
                        dockerImage = docker.build(imageTag, "services/frontend")
                    }
                }
            }
        }
        stage('Deploy Image') {
            steps {
                script {
                    docker.withServer('tcp://192.168.130.134:2376', dockerCredentials) {
                        dockerImage.push()
                    }
                }
            }
        }

        stage("Apply xebialabs.yaml") {
            steps {
                sh "sed -i.bak 's#xl-demo-frontend:latest#${imageTag}#' ./services/frontend/manifests/*.yaml"
                sh "./xlw apply -v -f services/frontend/xebialabs.yaml --values appversion=1.0.$BUILD_NUMBER"
            }
        }

    }
}