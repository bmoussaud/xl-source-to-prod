pipeline {
    environment {
        imageTag = "localhost:5000/xl-demo-backend:1.0.$BUILD_NUMBER"
        dockerCredentials = 'minikube'
        dockerImage = ''
    }
    agent any
    stages {
        stage('Cloning Git') {
            steps {
                git 'https://github.com/bmoussaud/xl-source-to-prod.git'
            }
        }
        stage('Building image') {
            steps {
                script {
                    docker.withServer('tcp://192.168.130.134:2376', dockerCredentials) {
                        dockerImage = docker.build(imageTag, "services/backend")
                    }
                }
            }
        }
        stage('Deploy Image') {
            steps {
                script {
                    docker.withServer('tcp://192.168.130.134:2376', dockerCredentials) {
                        dockerImage.push()
                    }
                }
            }
        }

        stage("Apply xebialabs.yaml") {
            steps {
                sh "sed -i.bak 's#xl-demo-backend:latest#${imageTag}#' ./services/backend/manifests/*.yml"
                sh "./xlw apply -v -f services/backend/xebialabs.yaml --values appversion=1.0.$BUILD_NUMBER"
            }
        }

    }
}