pipeline {
    environment {
        registry = "localhost:5000/xl-demo-backend"
        registryCredential = 'dockerhub'
        dockerImage = ''
    }
    agent any
    stages {
        stage('Cloning Git') {
            steps {
                git 'https://github.com/bmoussaud/xl-source-to-prod.git'
            }
        }
        stage('Building image') {
            steps {
                script {
                    docker.withServer('tcp://192.168.130.134:2376', 'minikube') {
                        dockerImage = docker.build(registry + ":$BUILD_NUMBER", "services/backend")
                    }
                }
            }
        }
        stage('Deploy Image') {
            steps {
                script {
                    docker.withServer('tcp://192.168.130.134:2376', 'minikube') {
                        dockerImage.push()
                    }
                }
            }
        }

        stage("Apply xebialabs.yaml") {
            steps {
                sh "./xlw apply -v -f services/backend/xebialabs.yaml --value appversion=$BUILD_NUMBER"
            }
        }

    }
}